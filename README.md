# Block Indent Controller v2.0

一个强大的 Obsidian 插件，提供增强的缩进控制、智能换行和上下文感知粘贴功能。

## ✨ 功能特性

### 🔧 整体块缩进控制
- **Alt+]**：增加整体块缩进 - 在行首添加制表符，包括 `>` 符号也会一起向右移动
- **Alt+[**：减少整体块缩进 - 删除行首的缩进，整个块向左移动

### 📝 引用层级控制
- **Ctrl+Alt+]**：增加引用层级 - 在最前面添加一个 `>` 符号
- **Ctrl+Alt+[**：减少引用层级 - 删除最前面的一个 `>` 符号

### 🎯 智能换行功能 ⭐ v2.0

**列表自动延续和智能前缀继承**

#### 核心特性
- **有序列表自动编号**：在 `1. 项目` 后按 Enter，自动生成 `2. `
- **无序列表自动延续**：在 `- 项目` 后按 Enter，自动生成 `- `
- **空列表项退出**：在空列表项按 Enter，移除列表标记但保持前缀
- **引用符和缩进继承**：在引用块中按 Enter，自动继承引用符和缩进
- **复杂嵌套支持**：完美支持 `> > > 1. 项目` 等复杂结构
- **智能光标定位**：精确识别光标位置，正确分割和移动内容

#### 快捷键
- **Enter**：智能换行（自动绑定）

### 🚀 智能粘贴功能 ⭐ v2.0

**基于第一性原理重新设计的上下文感知粘贴算法**

#### 核心特性
- **完美的引用嵌套**：正确处理多层嵌套引用块（`> > >`），使用绝对叠加算法
- **智能上下文识别**：光标在空行时自动向上查找最近的有效上下文
- **混合结构算法**：
  - 缩进：相对合并（去除公共前导缩进）
  - 引用层级：绝对叠加（完美嵌套）
- **代码块智能处理**：代码块内容视为纯文本，整体应用目标前缀
- **列表、表格、Callout**：全面支持各种Obsidian语法

#### 核心算法
```
缩进：最终缩进 = 目标缩进 + (源缩进 - 最小缩进)
引用：最终层级 = 目标层级 + 源层级
```

#### 功能亮点
- ✅ 智能光标位置处理（行中/行末/空行）
- ✅ 空行自动应用正确的前缀
- ✅ 跨平台换行符兼容
- ✅ 错误自动回退到普通粘贴
- ✅ 快捷键：`Ctrl+Shift+V`

### 🎨 其他智能处理
- 支持单行和多行操作
- 自动处理制表符和空格缩进
- 智能光标位置调整
- 兼容 Obsidian 的引用块语法

## 📦 安装方法

### 方法一：从 Obsidian 社区插件安装（推荐）
1. 打开 Obsidian 设置
2. 进入 **社区插件** 选项卡
3. 点击 **浏览**，搜索 "Block Indent Controller"
4. 点击 **安装** 并 **启用** 插件

### 方法二：手动安装
1. 下载最新的 `block-indent-controller.zip` 文件
2. 解压到你的 Obsidian 插件目录：`{你的库位置}/.obsidian/plugins/`
3. 重启 Obsidian
4. 在设置 → 社区插件 → 已安装插件中启用插件

## 🚀 使用方法

### 快捷键绑定
插件预设了以下快捷键：

| 功能 | 快捷键 | 描述 |
|------|--------|------|
| 增加整体块缩进 | `Alt + ]` | 向右缩进整个块 |
| 减少整体块缩进 | `Alt + [` | 向左缩进整个块 |
| 增加引用层级 | `Ctrl + Alt + ]` | 添加引用符号 `>` |
| 减少引用层级 | `Ctrl + Alt + [` | 删除引用符号 `>` |
| 智能换行 | `Enter` | 列表自动延续/前缀继承 |
| 智能粘贴 | `Ctrl + Shift + V` | 上下文感知粘贴 |

### 自定义快捷键
你可以在 Obsidian 设置中自定义这些快捷键：
1. 进入 **设置** → **快捷键**
2. 搜索 "Block Indent Controller"
3. 为每个命令设置你喜欢的快捷键

### 使用示例

#### 整体块缩进
```markdown
普通文本
```
按 `Alt + ]` 后：
```markdown
	普通文本
```

```markdown
> 引用文本
```
按 `Alt + ]` 后：
```markdown
	> 引用文本
```

#### 引用层级控制
```markdown
一级引用
```
按 `Ctrl + Alt + ]` 后：
```markdown
> 一级引用
```

```markdown
> 一级引用
```
按 `Ctrl + Alt + ]` 后：
```markdown
> > 二级引用
```

### 多行操作
选中多行文本后使用快捷键，可以同时处理所有选中的行。

### 智能粘贴示例

**场景 1：嵌套引用块粘贴（最重要的修复）**

原始内容：
```markdown
> [!multi-column]
> > [!multi-column]
> > > [!info]
> > 
> > > [!note]
> > 
> > > [!abstract]
> > 
```

复制自身并在最后一行末尾粘贴，期望结果：
```markdown
> [!multi-column]
> > [!multi-column]
> > > [!info]
> > 
> > > [!note]
> > 
> > > [!abstract]
> > > > [!multi-column]
> > > > > [!multi-column]
> > > > > > [!info]
> > > > > 
> > > > > > [!note]
> > > > > 
> > > > > > [!abstract]
> > > > > 
```

**场景 2：在缩进块中粘贴**
```markdown
当前行：
	这是一行有缩进的文本
```

复制以下内容：
```
第一行
	缩进的第二行
第三行
```

粘贴后（使用 `Ctrl+Shift+V`）：
```markdown
	这是一行有缩进的文本第一行
	第二行
		缩进的第二行
	第三行
```

**场景 3：混合格式粘贴**
```markdown
当前位置：
    > > - 列表项
```

复制以下内容：
```
> 第一行
> > 第二行
```

粘贴后：
```markdown
    > > - 列表项> 第一行
    > > > 第二行
```

**场景 4：光标位置影响**
- 光标在行中间：第一行接在光标后，不添加前缀
- 光标在行末/空行：所有行都应用结构合并

**场景 3：保持相对缩进层次 ⭐ 新功能**
```markdown
当前行：
	> 嵌套引用
```

复制以下有层次的内容：
```
主要内容
	缩进的内容
		更深层次的内容
其他内容
```

粘贴后（智能保持相对缩进）：
```markdown
	> 嵌套引用主要内容
	> 	缩进的内容
	> 		更深层次的内容
	> 其他内容
```

**场景 4：特殊内容保持原样**
对于代码块、表格、数学公式等特殊内容，插件会自动识别并保持原样粘贴：

```markdown
当前行：
	> 引用中的代码
```

粘贴代码块：
```
```
function example() {
    console.log("Hello World!");
}
```
```

结果保持原样（不会添加引用符号）：
```markdown
	> 引用中的代码
```
function example() {
    console.log("Hello World!");
}
```

## 🔧 兼容性

- **最低 Obsidian 版本**：0.15.0
- **平台支持**：Windows、macOS、Linux
- **兼容性**：完全兼容 Obsidian 的引用块语法

## 🛠️ 技术细节

### 核心数据结构
- **parseLine**：解析行结构，返回包含缩进、引用符号、列表标记和内容的对象。
- **rebuildLine**：从解析的结构重新生成行字符串。

### 缩进处理逻辑
- **制表符优先**：优先处理制表符缩进
- **空格兼容**：自动识别 2-4 个空格的缩进
- **智能调整**：根据当前缩进类型进行相应调整

### 引用处理逻辑
- **最前优先**：只修改当前缩进状态最靠前的 `>` 符号
- **空格保持**：保持引用符号后的空格格式

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

### 开发环境设置
1. 克隆此仓库
2. 安装依赖：`npm install`
3. 构建插件：`npm run build`
4. 将 `dist` 目录复制到你的 Obsidian 插件目录

## 📄 许可证

MIT License - 详见 [LICENSE](LICENSE) 文件

## 🙏 致谢

感谢 Obsidian 社区提供优秀的插件开发平台！

---

**作者**: Herta_Herselfta
